
policyApp.controller('ruleSetCtrl',['$scope','$http','$location','$window','$rootScope','$localStorage','RulesEngineService','ModalService','alertService','BASE_CONSTS','$timeout',function($scope,$http,$location,$window,$rootScope,$localStorage,RulesEngineService,ModalService,alertService,BASE_CONSTS,$timeout){$scope.json=null;$scope.selectRuleSetEl=function(getResp){var ruleSetObj;$scope.json=JSON.parse(getResp.definition.json);$scope.allRuleSets=$scope.json.ruleSets;if($scope.json.ruleSets===null||$scope.json.ruleSets===undefined){$scope.json.ruleSets=[];$scope.json.ruleSets.push(ruleSetObj);}
angular.forEach(getResp.elements,function(el,index){var draftId=el.id+BASE_CONSTS.DRAFT_CONST;angular.forEach(getResp.elements,function(el1,index){if(draftId==el1.id){el.hideRow=true;}});});};$rootScope.getRuleSetData=function(){var url='export'+'/'+$localStorage.selectedId+'/'+$localStorage.selectedVersion;RulesEngineService.getAllData(url).then(function(getResp){$scope.selectRuleSetEl(getResp);},function(error){$rootScope.errorNotification();});};$scope.isExpend=true;$scope.itemClick=function(id,expend){$scope.itemId=id;if(expend==undefined){expend=false;}
$scope.isExpend=!expend};$scope.deleteBtn=function(index){$scope.showConfirmModal(index);};$scope.makePostCall=function(item){var parentDN=$scope.findParentDN($scope.json,item,false);var url='element'+'/'+$localStorage.selectedId+'/'+$localStorage.selectedVersion+'/';if(item.elementType==='RULE_SET'){url=url+BASE_CONSTS.RULESET_CONST+'/';}else if(item.elementType==='RULE_SUB_SET'){url=url+BASE_CONSTS.RULESUBSET_CONST+'/';}else if(item.elementType==='RULE'){url=url+BASE_CONSTS.RULES_CONST+'/';}
url=url+parentDN+'/';url=url+item.id;RulesEngineService.deleteAllData(url).then(function(){$rootScope.getRuleSetData();$rootScope.deleteNotification();},function(error){$rootScope.errorNotification();});}
$scope.showConfirmModal=function(index){ModalService.showModal({templateUrl:'views/confirmModal.html',controller:"confirmModalCtrl",inputs:{deleteItem:$scope.allRuleSets[index].name}}).then(function(modal){modal.element.modal();modal.close.then(function(result){if(result==='Yes'){$scope.makePostCall(index);}});});};$scope.editBtn=function(item){var parentDN=$scope.findParentDN($scope.json,item,false);ModalService.showModal({templateUrl:'/views/ruleSetModal.html',controller:"ruleSetModalCtrl",inputs:{ruleSetEle:item,newRuleSet:false,modalType:'edit',ruleJson:$scope.json,creatUrl:parentDN}}).then(function(modal){modal.element.modal();modal.close.then(function(){});});};$scope.addBtn=function(item){var parentDN=$scope.findParentDN($scope.json,item,true);ModalService.showModal({templateUrl:'/views/ruleSetModal.html',controller:"ruleSetModalCtrl",inputs:{ruleSetEle:item,newRuleSet:true,modalType:'add',ruleJson:$scope.json,creatUrl:parentDN}}).then(function(modal){modal.element.modal();modal.close.then(function(){});});};$scope.addNewRuleSet=function(newRuleSet){var parentDN="~";var newRuleSet={};ModalService.showModal({templateUrl:'/views/ruleSetModal.html',controller:"ruleSetModalCtrl",inputs:{ruleSetEle:newRuleSet,newRuleSet:true,modalType:'create',ruleJson:$scope.json,creatUrl:parentDN}}).then(function(modal){modal.element.modal();modal.close.then(function(){});});};$scope.findParentDN=function(ruleDefinition,selectedItem,includeMe){var ruleSets=ruleDefinition.ruleSets;var parentList=[];for(var i=0;i<ruleSets.length;i++){var ruleSet=ruleSets[i];if(ruleSet.id==selectedItem.id){if(includeMe){parentList.push(ruleSet.id);}
break;}else{for(var j=0;j<ruleSet.rules.length;j++){var abstractRule=ruleSet.rules[j];if(abstractRule.elementType=="RULE"){if(abstractRule.id==selectedItem.id){parentList.push(ruleSet.id);break;}}else if(abstractRule.elementType=="RULE_SUB_SET"){var selection=$scope.iterateSubSetForParentDN(abstractRule,selectedItem,includeMe,parentList);if(selection){parentList.push(ruleSet.id);break;}}}}}
var parentDN="";if(parentList.length<1){parentDN="~";}else{var i=0;angular.forEach(parentList,function(id,index){if(i>0){parentDN=parentDN+",c1Id="+id;}else{parentDN=parentDN+"c1Id="+id;}
i++;});}
return parentDN;};$scope.iterateSubSetForParentDN=function(subSet,selectedItem,includeMe,parentList){if(subSet.id==selectedItem.id){if(includeMe){parentList.push(subSet.id);}
return true;}
if(subSet.rules==null||subSet.rules.length<1||subSet.rules==undefined){return;}
for(var j=0;j<subSet.rules.length;j++){var abstractRule=subSet.rules[j];if(abstractRule.elementType=="RULE"){if(abstractRule.id==selectedItem.id){parentList.push(subSet.id);return true;}}else if(abstractRule.elementType=="RULE_SUB_SET"){var selection=$scope.iterateSubSetForParentDN(abstractRule,selectedItem,includeMe,parentList);if(selection){parentList.push(subSet.id);return true;}}}
return false;};$rootScope.getRuleSetData();}]);policyApp.filter('filterTreeItem',function(){function recursive(obj,newObj,level,itemId,isExpend){angular.forEach(obj,function(o){if(o.rules&&o.rules.length!=0){o.level=level;o.leaf=false;newObj.push(o);if(o.id==itemId){o.expend=isExpend;}
if(o.expend==true){recursive(o.rules,newObj,o.level+1,itemId,isExpend);}}else{o.level=level;if(o.elementType!='RULE_SUB_SET'&&o.elementType!='RULE_SET'){o.leaf=true;}
newObj.push(o);return false;}});}
return function(obj,itemId,isExpend){var newObj=[];recursive(obj,newObj,0,itemId,isExpend);return newObj;}});